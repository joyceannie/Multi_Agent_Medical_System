<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi-Agent Healthcare Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white shadow-xl rounded-2xl max-w-2xl w-full p-8">
    <h1 class="text-2xl font-bold mb-6 text-blue-700">üè• Multi-Agent Healthcare Assistant</h1>

    <form id="analyze-form" class="space-y-4" novalidate>
      <div>
        <label for="note" class="block text-sm font-medium text-gray-700">Upload clinical note or transcript</label>
        <textarea id="note" name="note"
          class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm p-2 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
          rows="6" placeholder="Enter clinical notes here..."></textarea>
      </div>

      <div>
        <label for="image" class="block text-sm font-medium text-gray-700">Upload Image (X-ray, MRI, etc.)</label>
        <input type="file" id="image" name="image" accept="image/*"
          class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200" />
      </div>

      <button type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow">
        Analyze
      </button>
    </form>

    <div id="response"
      class="mt-6 bg-gray-100 rounded-lg p-4 text-sm text-gray-800 whitespace-pre-wrap hidden border border-gray-200 overflow-auto max-h-96">
    </div>
  </div>

  <script>
    const form = document.getElementById('analyze-form');
    const responseDiv = document.getElementById('response');
    const noteField = document.getElementById('note');
    const imageField = document.getElementById('image');

    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderResponse(data) {
      if (data.error) {
        return `<span class="text-red-600 font-semibold">‚ùå Error:</span> ${escapeHtml(data.error)}`;
      }

      switch (data.agent) {
        case "icd10":
          return data.result.map(code =>
            `<div class="mb-3">
              <div><strong>Code:</strong> ${escapeHtml(code.code)}</div>
              <div><strong>Description:</strong> ${escapeHtml(code.description)}</div>
            </div>`
          ).join('<hr class="my-2" />');

        case "soap":
          return `
            <div><strong>Subjective:</strong><br/>${escapeHtml(data.result.Subjective)}</div>
            <div class="mt-3"><strong>Objective:</strong><br/>${escapeHtml(data.result.Objective)}</div>
            <div class="mt-3"><strong>Assessment:</strong><br/>${escapeHtml(data.result.Assessment)}</div>
            <div class="mt-3"><strong>Plan:</strong><br/>${escapeHtml(data.result.Plan)}</div>
          `;

        case "image_analysis":
          return `
            <div><strong>Technique:</strong><br/>${escapeHtml(data.result.technique)}</div>
            <div class="mt-3"><strong>Findings:</strong><br/>${escapeHtml(data.result.findings)}</div>
            <div class="mt-3"><strong>Impression:</strong><br/>${escapeHtml(data.result.impression)}</div>
            <div class="mt-3"><strong>Recommendations:</strong><br/>${escapeHtml(data.result.recommendations)}</div>
            ${
              data.result.answer_to_user_question
                ? `<div class="mt-3"><strong>Answer to question:</strong><br/>${escapeHtml(data.result.answer_to_user_question)}</div>`
                : ''
            }
          `;

        default:
          return `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
      }
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      if (!noteField.value.trim() && imageField.files.length === 0) {
        responseDiv.classList.remove('hidden');
        responseDiv.innerHTML = "‚ö†Ô∏è Please provide at least a clinical note or an image.";
        return;
      }

      const formData = new FormData();
      formData.append('note', noteField.value);
      if (imageField.files.length > 0) {
        formData.append('image', imageField.files[0]);
      }

      responseDiv.classList.remove('hidden');
      responseDiv.innerHTML = "‚è≥ Processing...";

      try {
        const res = await fetch('/api/analyze', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        responseDiv.innerHTML = renderResponse(data);
      } catch (err) {
        responseDiv.innerHTML = "‚ùå An error occurred while submitting your request.";
      }
    });
  </script>
</body>
</html>
